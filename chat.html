<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .clearfix:before, .clearfix:after {
            content: "";
            display: table;
        }

        .clearfix:after {
            clear: both;
        }

        .clearfix {
            zoom: 1;
        }

        ul, li {
            list-style: none;
        }

        .thread-container {
            padding: 10px;
        }

        .thread-list {
            border: solid 1px #00b7ee;
            width: 250px;
            float: left;
        }

        .thread {
            padding: 5px;
            cursor: pointer;
        }

        .thread:hover, .active {
            background: #00b7ee;
        }

        .chat-wrap {
            border: solid 1px #00b7ee;
            float: left;
            min-width: 700px;
            max-width: 750px;
            margin-left: 10px;
        }

        .underline {
            border-bottom: 1px solid #00b7ee;
        }

        .chat-content {
            padding: 5px;
            min-height: 700px;
            max-height: 750px;
        }

        .chat-send {
            padding: 5px;
            height: 150px;
            position: relative;
        }

        .chat-send a {
            position: absolute;
            background: #00b7ee;
            text-decoration: none;
            border: 1px solid #9933ff;
            border-radius: 2px;
            top: 120px;
            right: 33px;
            letter-spacing: 2px;
            padding: 2px;
        }

        .thread-avatar {
            float: left;
            width: 40px;
            height: 40px;
        }

        .thread-avatar img {
            width: 40px;
            height: 40px;
        }

        .thread-content {
            float: left;
            width: 60%;
        }

        .thread-content-head, .thread-content-body {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .thread-time {
            float: right;
        }
    </style>
</head>
<body>
<div class="thread-container">
    <ul class="thread-list">
        <li class="thread clearfix">
            <div class="thread-avatar">
                <img src="/image/emoji/00a9.png" alt="">
            </div>
            <div class="thread-content">
                <div class="thread-content-head">Allen</div>
                <div class="thread-content-body">send you a message</div>
            </div>
            <div class="thread-time">01/17</div>
        </li>
        <li class="thread clearfix">
            <div class="thread-avatar">
                <img src="/image/emoji/00a9.png" alt="">
            </div>
            <div class="thread-content">
                <div class="thread-content-head">Allen</div>
                <div class="thread-content-body">send you a message</div>
            </div>
            <div class="thread-time">01/17</div>
        </li>
    </ul>
    <div class="chat-wrap">
        <div class="chat-content">123456789</div>
        <div class="underline"></div>
        <div class="chat-send">
            <textarea name="" id="" cols="95" rows="10"></textarea>
            <a href="javascript:;">发送</a>
        </div>
    </div>
</div>
</body>
<script src="lib/jquery.js"></script>
<script src="lib/fetch.js"></script>
<script src="lib/promise-6.1.0.js"></script>
<script src="lib/jquery.tmpl.js"></script>
<script src="lib/lodash.min.js"></script>
<script src="lib/moment.min.js"></script>
<script type="text/html" id="threadTmpl">
    <li class="thread clearfix">
        <div class="thread-avatar">
            <img src="/image/emoji/00a9.png" alt="">
        </div>
        <div class="thread-content">
            <div class="thread-content-head">{{= title}}</div>
            <div class="thread-content-body">{{= info.content}}</div>
        </div>
        <div class="thread-time">{{= moment(longDate).format('MM/DD')}}</div>
    </li>
</script>
<script>
    $(function () {
        var userId = 'ZmOaK1ylZehx2qX1';

        var chatStore = {
            threadList: [],
            currentMsgId: ''
        };

        loadThreadList();

        //请求用户列表
        function loadThreadList() {
            return fetch('http://localhost:1001/launchr/chat/unreadsession', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "userName": userId,
                    "start": 0,
                    "end": 50
                })
            }).then(function (res) {
                return res.json()
            }).then(function (json) {
//                var threadList = json.sessions && json.sessions.map(function (item) {
//                            return _.assign(item, {
//                                lastMsg: item.lastMsg ? _.assign(item.lastMsg,
//                                        {content: item.lastMsg.from.endsWith('@APP') ? 'an App Msg' : item.lastMsg.content},
//                                        {info: JSON.parse(item.lastMsg.info)}) : ''
//                            })
//                        })
//                $('.thread-list').html($('#threadTmpl').tmpl(threadList));
                dealUnreadSession(0, json, function (data) {
                    if (data != null) {
                        chatStore.threadList.push(data);
                    } else {
                        return chatStore.threadList;
                    }
                })
            })
        }

        //批量处理用户会话列表
        function dealUnreadSession(index, res, callback) {
            if (index >= (res.sessions || []).length) {
                chatStore.currentMsgId=res.msgId;
                //渲染会话
                renderThread(chatStore.threadList)
                return;
            }

            var item = res.sessions[index];
            if (!item.sessionName.endsWith('@APP') && item.lastMsg) {
                loadUserInfo(item).then(function (data) {
                    if (data != null) {
                        callback(data);
                    }
                    dealUnreadSession(index + 1, res, callback);
                })
            } else {
                dealUnreadSession(index + 1, res, callback);
            }
        }

        //适配用户对象
        function loadUserInfo(item) {
            var otherValue = {
                type: 'chat',
                count: item.count,
                threadID: item.sessionName,
                info: {},
                timer: '',
                longDate: 0,
                code: ''
            };

            if (item.lastMsg != null) {
                otherValue = _.assign({}, otherValue, {
                    info: {
                        extend: item.lastMsg.info,
                        content: item.lastMsg.content,
                        type: item.lastMsg.type,
                        myId: userId
                    },
                    timer: item.lastMsg.createDate,
                    longDate: item.lastMsg.createDate
                })
            }

            var title = '';
            var reg = /^[0-9a-zA-Z]{1,}@ChatRoom$/;
            if (!reg.test(item.sessionName)) {
                title = item.nickName;
                if (title) {
                  return  Promise.resolve(_.assign({}, otherValue, {title: title, count: item.count}))
                }
            }

            return fetch('http://localhost:1001/launchr/chat/session', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "userName": "ZmOaK1ylZehx2qX1",
                    "sessionName": item.sessionName
                })
            }).then(function (res) {
                return res.json()
            }).then(function (json) {
                if (json.code == '2000') {
                    otherValue = _.assign({}, otherValue, {
                        threadID: json.data.userName,
                        title: json.data.nickName,
                        longDate: json.data.modified
                    })

                    if (!reg.test(item.sessionName)) {
                        return otherValue;
                    } else {
                        if (_.find(json.data.memberList, {'userName': userId}) != null) {
                            return _.assign({},
                                    otherValue, {
                                        memberList: json.data.memberList
                                    })
                        }
                    }
                }
                return null;
            })
        }

        function renderThread(threadList) {
            $('.thread-list').html($('#threadTmpl').tmpl(threadList));
        }
    })
</script>
</html>