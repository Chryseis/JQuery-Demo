<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .clearfix:before, .clearfix:after {
            content: "";
            display: table;
        }

        .clearfix:after {
            clear: both;
        }

        .clearfix {
            zoom: 1;
        }

        ul, li {
            list-style: none;
        }

        .thread-container {
            padding: 10px;
        }

        .thread-list {
            border: solid 1px #00b7ee;
            width: 250px;
            float: left;
        }

        .thread {
            padding: 5px;
            cursor: pointer;
        }

        .thread:hover, .active {
            background: #00b7ee;
        }

        .chat-wrap {
            /*border: solid 1px #00b7ee;*/
            overflow: hidden;
            padding-left: 20px;
        }

        .chat-inner-wrap {
            border: solid 1px #00b7ee;
        }

        .underline {
            border-bottom: 1px solid #00b7ee;
        }

        .chat-content {
            padding: 5px;
            min-height: 700px;
            max-height: 750px;
        }

        .chat-send {
            /*padding: 5px;*/
            height: 150px;
            position: relative;
        }

        .chat-send a {
            position: absolute;
            background: #00b7ee;
            text-decoration: none;
            border: 1px solid #9933ff;
            border-radius: 2px;
            top: 120px;
            right: 20px;
            letter-spacing: 2px;
            padding: 2px;
        }

        .thread-avatar {
            float: left;
            width: 40px;
            height: 40px;
        }

        .thread-avatar img {
            width: 40px;
            height: 40px;
        }

        .thread-content {
            float: left;
            width: 60%;
        }

        .thread-content-head, .thread-content-body {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .thread-time {
            float: right;
        }

        .chat-content-img {
            width: 40px;
            height: 40px;
            float: left;
        }

        .chat-content-wrap {
            overflow: hidden;
            padding: 3px 9px;
        }

        .chat-content-detail {
            border: 1px solid #00b7ee;
            border-radius: 3px;
            line-height: 25px;
            padding: 3px;
            word-wrap: break-word;
            display: inline-block;
            white-space: pre-line;
            max-width: 70%
        }

        .chat-content-wrap-me {
            text-align: right;
        }

        .chat-content-item {
            padding: 5px 0;
        }
    </style>
    <link rel="stylesheet" href="./css/quill.snow.css">
</head>
<body>
<div class="thread-container clearfix">
    <ul class="thread-list">
    </ul>
    <div class="chat-wrap">
        <div class="chat-inner-wrap">
            <div class="chat-content">
                <ul class="clearfix">
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <div class="chat-content-wrap-me">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">1231123123123133131231313133112311231231231331312313131331123112312312313313123131313311231123123123133131231313133112311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <div class="chat-content-wrap-me">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">12311231231231331312313131331</pre>
                        </div>
                    </li>
                    <li class="chat-content-item">
                        <img class="chat-content-img" src="/image/emoji/1f4bb.png" alt="">
                        <div class="chat-content-wrap">
                            <pre class="chat-content-detail">1231123123123133131231313133112311231231231331312313131331123112312312313313123131313311231123123123133131231313133112311231231231331312313131331</pre>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="underline"></div>
            <div class="chat-send">
                <div id="toolbar" style="position: relative">
                    <!-- Add a bold button -->
                    <button class="ql-bold"></button>
                    <!-- Add subscript and superscript buttons -->
                    <button class="ql-script" value="sub"></button>
                    <button class="ql-script" value="super"></button>
                </div>
                <div id="editor" style="height: calc(100% - 42px);">
                </div>
                <a href="javascript:;">发送</a>
            </div>
        </div>
    </div>
</div>
</body>
<script src="lib/jquery.js"></script>
<script src="lib/fetch.js"></script>
<script src="lib/promise-6.1.0.js"></script>
<script src="lib/jquery.tmpl.js"></script>
<script src="lib/lodash.min.js"></script>
<script src="lib/moment.min.js"></script>
<script src="lib/quill.min.js"></script>
<script type="text/html" id="threadTmpl">
    <li class="thread clearfix">
        <div class="thread-avatar">
            <img src="/image/emoji/00a9.png" alt="">
        </div>
        <div class="thread-content">
            <div class="thread-content-head">{{= title}}</div>
            <div class="thread-content-body">{{= info.content}}</div>
        </div>
        <div class="thread-time">{{= moment(longDate).format('MM/DD')}}</div>
    </li>
</script>
<script type="text/html" id="contentTmpl">

</script>
<script>
    $(function () {
        //var userId = 'ZmOaK1ylZehx2qX1'; //mt
        var userId = 'ZBAYNbRqYAUBbjDE3';//totoro

        var chatStore = {
            threadList: [],
            currentMsgId: '',
            currentThreadID: ''
        };

        //富文本编辑器
        var snowEditor = new Quill('#editor', {
            modules: {
                toolbar: '#toolbar'
            },
            theme: 'snow'
        });

        loadThreadList();

        //请求用户列表
        function loadThreadList() {
            return fetch('http://localhost:1001/launchr/chat/unreadsession', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "userName": userId,
                    "start": 0,
                    "end": 50
                })
            }).then(function (res) {
                return res.json()
            }).then(function (json) {
                dealUnreadSession(0, json, function (data) {
                    if (data != null) {
                        chatStore.threadList.push(data);
                    } else {
                        return chatStore.threadList;
                    }
                })
            })
        }

        //批量处理用户会话列表
        function dealUnreadSession(index, res, callback) {
            if (index >= (res.sessions || []).length) {
                chatStore.currentMsgId = res.msgId;
                //渲染会话
                renderThread(chatStore.threadList)
                //订阅消息
                loadLongPoll();
                return;
            }

            var item = res.sessions[index];
            if (!item.sessionName.endsWith('@APP') && item.lastMsg) {
                loadUserInfo(item).then(function (data) {
                    if (data != null) {
                        callback(data);
                    }
                    dealUnreadSession(index + 1, res, callback);
                })
            } else {
                dealUnreadSession(index + 1, res, callback);
            }
        }

        //适配用户对象
        function loadUserInfo(item, sessionName) {
            var otherValue = {
                type: 'chat',
                count: item.count || 0,
                threadID: item.sessionName || sessionName,
                info: {},
                timer: '',
                longDate: 0,
                code: ''
            };

            if (item.lastMsg != null) {
                otherValue = _.assign({}, otherValue, {
                    info: {
                        extend: item.lastMsg.info,
                        content: item.lastMsg.content,
                        type: item.lastMsg.type,
                        myId: userId
                    },
                    timer: item.lastMsg.createDate,
                    longDate: item.lastMsg.createDate
                })
            } else {
                otherValue = _.assign({}, otherValue, {
                    info: {
                        extend: item.info,
                        content: item.content,
                        type: item.type,
                        myId: userId
                    },
                    timer: item.createDate,
                    longDate: item.createDate
                })
            }

            var title = '';
            var reg = /^[0-9a-zA-Z]{1,}@ChatRoom$/;
            if (!reg.test(item.sessionName || sessionName)) {
                title = item.nickName || JSON.parse(item.info).nickName;
                if (title) {
                    return Promise.resolve(_.assign({}, otherValue, {title: title, count: item.count || 0}))
                }
            }

            return fetch('http://localhost:1001/launchr/chat/session', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "userName": userId,
                    "sessionName": item.sessionName
                })
            }).then(function (res) {
                return res.json()
            }).then(function (json) {
                if (json.code == '2000') {
                    otherValue = _.assign({}, otherValue, {
                        threadID: json.data.userName,
                        title: json.data.nickName,
                        longDate: json.data.modified
                    })

                    if (!reg.test(item.sessionName)) {
                        return otherValue;
                    } else {
                        if (_.find(json.data.memberList, {'userName': userId}) != null) {
                            return _.assign({},
                                otherValue, {
                                    memberList: json.data.memberList
                                })
                        }
                    }
                }
                return null;
            })
        }

        //轮循消息
        function loadLongPoll() {
            var currentMsgId = chatStore.currentMsgId;
            return fetch('http://localhost:1001/launchr/chat/subscribemessage', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "userName": userId,
                    "msgId": currentMsgId,
                    "milliseconds": 20000
                })
            }).then(function (res) {
                return res.json();
            }).then(function (json) {
                if (json.code === 2000) {
                    dealPollMsg(0, json.msg)
                } else {
                    setTimeout(function () {
                        loadLongPoll()
                    }, 1000)
                }
            })
        }

        //处理消息
        function dealPollMsg(index, msg) {
            if (index >= msg.length) {
                chatStore.threadList.sort(function (a, b) {
                    return b.timer > a.timer
                })
                renderThread(chatStore.threadList);
                //修改最大消息id
                msg.length > 0 && (chatStore.currentMsgId = msg[msg.length - 1].msgId);
                loadLongPoll();
                return;
            }
            var item = msg[index];
            var myself = item.from == userId;
            var sessionId = myself ? item.to : item.from;
            var currentTalk = sessionId == chatStore.currentThreadID;
            //处理消息
            var currentThread = _.find(chatStore.threadList, function (item) {
                return item.threadID == sessionId;
            });
            if (currentThread == null) {
                loadUserInfo(item, sessionId).then(function (user) {
                    var thread = _.assign({}, user, {count: myself ? 0 : 1});
                    chatStore.threadList.unshift(thread);
                })
            } else {
                //修改thread
                currentThread.info = {extend: item.info, content: item.content, type: item.type, myId: userId};
                currentThread.timer = item.createDate;
                currentThread.count = myself ? 0 : currentThread.count + 1;
            }
            dealPollMsg(index + 1, msg);
        }

        //加载历史记录
        function initHistory() {
            fetch('http://localhost:1001/launchr/chat/historymessage', {
                mode: 'cors',
                method: 'post',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    "appName": "launchr",
                    "appToken": "verify-code",
                    "from": userId,
                    "to": item.sessionName,
                    "limit": 30,
                    "endTimestamp": -1
                })
            })
        }

        //渲染会话列表
        function renderThread(threadList) {
            $('.thread-list').html($('#threadTmpl').tmpl(threadList));
        }

        //渲染历史
        function renderHistory() {

        }
    })
</script>
</html>